#!/bin/bash

START_TIME=$SECONDS

process () {
    SCAD=$1
    BASE=${SCAD/%.scad/}
    DIR=$(dirname "$SCAD")

    mkdir -p "build/stl/$DIR"

    echo "  $SCAD..."
    LAST_LAP=$SECONDS
    openscad -o build/stl/$BASE.stl build/scad/$SCAD
    echo "    $(($SECONDS - $LAST_LAP)) secs" && LAST_LAP=$SECONDS
}

image () {
    SCAD=$1
    CAMERA=$2
    BASE=${SCAD/%.scad/}
    DIR=$(dirname "$SCAD")

    mkdir -p "build/png/$DIR"

    echo "  $SCAD..."
    LAST_LAP=$SECONDS
    openscad --imgsize=4000,3000 --camera=$CAMERA --colorscheme=Cornfield --projection=p -o build/png/$BASE.png build/scad/$SCAD
    echo "    $(($SECONDS - $LAST_LAP)) secs" && LAST_LAP=$SECONDS

    #(widthxheight+left+top / wxh+l+t format)
    #convert gate_on_basement.png -crop 500x500+30+30 gate_on_basement.png

    #convert -trim input.jpg output.jpg
    #-resize 64x64
}


echo ""
echo "Build"
echo "====="

#
#echo ""
#echo "## GATE"
#
#process "print/gate/upright.scad"
#process "print/gate/angle.scad"
#process "print/gate/traverse.scad"
#
#echo ""
#echo "### Variant"
#
#process "print/gate/variant/traverse_split_L.scad"
#process "print/gate/variant/traverse_split_R.scad"
#process "print/gate/variant/traverse_split_toothpick_3of3.scad"
#process "print/gate/variant/traverse_split_toothpick_2of3.scad"
#process "print/gate/variant/traverse_split_toothpick_1of3.scad"
#process "print/gate/variant/upright_with_angle_joints_holes.scad"
#process "print/gate/variant/upright_angle_joint_toothpick.scad"
#
#echo ""
#process "print/gate/variant/traverse_without_basement.scad"
#process "print/gate/variant/traverse_without_basement_split_L.scad"
#process "print/gate/variant/traverse_without_basement_split_R.scad"
#
#
#echo ""
#echo "## BASEMENT"
#
#process "print/basement/basement_box_controller_bottom.scad"
#process "print/basement/basement_box_controller_side_slide.scad"
#process "print/basement/basement_box_controller_top.scad"
#
#echo ""
#process "print/basement/basement_box_terminal_bottom.scad"
#process "print/basement/basement_box_terminal_side_slide.scad"
#process "print/basement/basement_box_terminal_top.scad"
#
#
#echo ""
#echo "### Variant"
#
#process "print/basement/variant/basement_block.scad"
#process "print/basement/variant/basement_block_with_hole.scad"
#process "print/basement/variant/basement_box_controller_top_without_hole.scad"
#process "print/basement/variant/basement_box_controller_top_with_groove.scad"
#process "print/basement/variant/basement_box_terminal_top_with_groove.scad"
#
#echo ""
#echo "### Utility"
#
#echo ""
#process "print/basement/utility/basement_box_top_hole_cap.scad"
#
#echo ""
process "print/basement/utility/basement_ground_guide_box_controller.scad"
process "print/basement/utility/basement_ground_guide_box_terminal.scad"
#
#echo ""
#echo "## GROUND"
#
#process "print/ground/ground_with_hole.scad"
#process "print/ground/ground_without_hole.scad"
#
#
#echo ""
#echo "## STARTLIGHTS"
#
#process "print/startlights/startlights.scad"
#process "print/startlights/hanger_clip.scad"
#process "print/startlights/hanger_rod.scad"


#echo ""
#echo "# SIM"
#
#image "sim/gate_on_basement.scad" "120,50,0,60,0,-20,800"
#image "sim/gate_on_ground.scad" "120,50,0,60,0,-20,800"


echo ""
echo "Build for Thingiverse"
echo "====================="
mkdir -p "build/stl/thingiverse"
find "build/stl/print" -type f -iname '*.stl' -exec bash -c '
    tmp1="${1#*/}"
    tmp2="${tmp1/stl\/print\//}"
    filename="${tmp2//\//.}"
    cp -nv "${1}" "build/stl/thingiverse/${filename}" ' sh_cp {} \;


echo ""
echo "DONE"
echo "   in $(($SECONDS - $START_TIME)) secs"
echo ""
